name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop

jobs:
  build_docker_image:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.USER_NAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ðŸ”¥ Build Production (NO CACHE)
      - name: Build Production Docker image
        if: github.ref == 'refs/heads/main'
        run: |
          docker build --no-cache \
            --build-arg NODE_ENV=production \
            -t ghcr.io/intuition-business/timshel/backend:production \
            -t ghcr.io/intuition-business/timshel/backend:production-${{ github.sha }} \
            .

      # Build Development
      - name: Build Development Docker image
        if: github.ref == 'refs/heads/develop'
        run: |
          docker build --no-cache \
            --build-arg NODE_ENV=dev \
            -t ghcr.io/intuition-business/timshel/backend:dev \
            -t ghcr.io/intuition-business/timshel/backend:dev-${{ github.sha }} \
            .

      # Push Production
      - name: Push Production Docker image
        if: github.ref == 'refs/heads/main'
        run: |
          docker push ghcr.io/intuition-business/timshel/backend:production
          docker push ghcr.io/intuition-business/timshel/backend:production-${{ github.sha }}

      # Push Development
      - name: Push Development Docker image
        if: github.ref == 'refs/heads/develop'
        run: |
          docker push ghcr.io/intuition-business/timshel/backend:dev
          docker push ghcr.io/intuition-business/timshel/backend:dev-${{ github.sha }}

  deploy_production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build_docker_image
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Install SSH tools
        run: sudo apt-get update && sudo apt-get install -y openssh-client sshpass

      - name: Decode SSH key
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" | base64 -d > my_ssh
          chmod 400 my_ssh

      - name: Create .env for production
        run: |
          echo PORT=${{ secrets.PORT }} > .env
          echo NODE_ENV=production >> .env
          echo SECRET_KEY_JWT=${{ secrets.SECRET_KEY_JWT }} >> .env
          echo TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }} >> .env
          echo TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }} >> .env
          echo TWILIO_NUMBER=${{ secrets.TWILIO_NUMBER }} >> .env
          echo API_KEY_SENDGRID=${{ secrets.API_KEY_SENDGRID }} >> .env
          echo GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} >> .env
          echo GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }} >> .env
          echo HOST=${{ secrets.HOST }} >> .env
          echo USER_DB=${{ secrets.USER_DB }} >> .env
          echo PASSWORD_DB=${{ secrets.PASSWORD_DB }} >> .env
          echo DATABASE=${{ secrets.DATABASE }} >> .env
          echo PORT_DB=${{ secrets.PORT_DB }} >> .env
          echo AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} >> .env
          echo AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} >> .env
          echo AWS_REGION=${{ secrets.AWS_REGION }} >> .env
          echo AWS_BUCKET_NAME=${{ secrets.AWS_BUCKET_NAME }} >> .env
          echo OPENIA_KEY=${{ secrets.OPENIA_KEY }} >> .env
          echo BREVO_API_KEY=${{ secrets.BREVO_API_KEY }} >> .env

      - name: Copy .env to server
        run: |
          sshpass scp -i my_ssh -o StrictHostKeyChecking=no .env \
          ec2-user@${{ secrets.SERVER_IP }}:/home/ec2-user/.env

      - name: Deploy on EC2
        run: |
          sshpass ssh -i my_ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.SERVER_IP }} << EOF
            sudo docker login ghcr.io -u "${{ secrets.USER_NAME }}" -p "${{ secrets.DOCKER_PASSWORD }}"

            # ðŸ”¥ liberar espacio antes del pull
            sudo docker system prune -a -f || true

            # pull tag exacto del commit (evita cache / confusiÃ³n)
            sudo docker pull ghcr.io/intuition-business/timshel/backend:production-${{ github.sha }}

            sudo docker stop timshel-backend || true
            sudo docker rm timshel-backend || true

            # ðŸ”¥ fuerza a correr PROD real (npm start)
            sudo docker run -d \
              --name timshel-backend \
              --env-file /home/ec2-user/.env \
              -p 3000:3000 \
              ghcr.io/intuition-business/timshel/backend:production-${{ github.sha }} \
              npm start

            # opcional: logs cortos
            sudo docker logs --tail 50 timshel-backend
          EOF
